# 附录

<cite>
**本文档中引用的文件**
- [definitions.rs](file://src/vmx/definitions.rs)
- [Cargo.toml](file://Cargo.toml)
- [rust-toolchain.toml](file://rust-toolchain.toml)
</cite>

## 目录
1. [Intel SDM章节索引](#intel-sdm章节索引)
2. [常量与枚举值定义](#常量与枚举值定义)
3. [错误码对照表](#错误码对照表)
4. [VT-x特性支持程度](#vt-x特性支持程度)
5. [版本兼容性说明](#版本兼容性说明)
6. [术语表](#术语表)

## Intel SDM章节索引

本节列出与项目核心功能相关的Intel软件开发者手册（Software Developer's Manual, SDM）卷册及关键章节，便于查阅原始规范。

### VMX相关章节
- **SDM 第3C卷**：系统编程指南 - 第24章 "Virtual Machine Extensions (VMX)"  
  涵盖VMX操作模式、VMCS结构、VM进入与退出机制、中断处理等内容。
- **SDM 第3D卷**：系统编程指南 - 附录C "Basic VM-Exit Reasons"  
  定义了所有可能触发VM退出的基本原因码，对应代码中的`VmxExitReason`枚举。

### EPT相关章节
- **SDM 第3C卷**：系统编程指南 - 第28章 "Extended Page Tables (EPT)"  
  描述EPT的工作原理、页表格式、内存类型支持以及EPT违规处理机制。

### 系统管理模式（SMM）相关章节
- **SDM 第3C卷**：系统编程指南 - 第34章 "System Management Mode (SMM)"  
  介绍SMM的架构、SMI处理流程、SMM下的VMX操作限制及相关安全考虑。

**Section sources**
- [definitions.rs](file://src/vmx/definitions.rs#L0-L274)

## 常量与枚举值定义

本节列出并解释`definitions.rs`中定义的关键常量和枚举值。

### VM-exit原因码（VmxExitReason）

| 枚举值 | 数值 | 中文解释 |
|--------|------|----------|
| EXCEPTION_NMI | 0 | 发生异常或不可屏蔽中断（NMI） |
| EXTERNAL_INTERRUPT | 1 | 接收到外部中断 |
| TRIPLE_FAULT | 2 | 发生三重故障 |
| INIT | 3 | 接收到INIT信号 |
| SIPI | 4 | 接收到启动IPI（SIPI） |
| SMI | 5 | 接收到系统管理中断（SMI） |
| OTHER_SMI | 6 | 接收到其他SMI |
| INTERRUPT_WINDOW | 7 | 中断窗口开启 |
| NMI_WINDOW | 8 | NMI窗口开启 |
| TASK_SWITCH | 9 | 发生任务切换 |
| CPUID | 10 | 执行CPUID指令 |
| GETSEC | 11 | 执行GETSEC指令 |
| HLT | 12 | 执行HLT指令 |
| INVD | 13 | 执行INVD指令 |
| INVLPG | 14 | 执行INVLPG指令 |
| RDPMC | 15 | 执行RDPMC指令 |
| RDTSC | 16 | 执行RDTSC指令 |
| RSM | 17 | 在SMM中执行RSM指令 |
| VMCALL | 18 | 执行VMCALL指令 |
| VMCLEAR | 19 | 执行VMCLEAR指令 |
| VMLAUNCH | 20 | 执行VMLAUNCH指令 |
| VMPTRLD | 21 | 执行VMPTRLD指令 |
| VMPTRST | 22 | 执行VMPTRST指令 |
| VMREAD | 23 | 执行VMREAD指令 |
| VMRESUME | 24 | 执行VMRESUME指令 |
| VMWRITE | 25 | 执行VMWRITE指令 |
| VMOFF | 26 | 执行VMOFF指令 |
| VMON | 27 | 执行VMON指令 |
| CR_ACCESS | 28 | 访问控制寄存器（CR） |
| DR_ACCESS | 29 | 访问调试寄存器（DR） |
| IO_INSTRUCTION | 30 | 执行I/O指令 |
| MSR_READ | 31 | 读取模型特定寄存器（MSR） |
| MSR_WRITE | 32 | 写入模型特定寄存器（MSR） |
| INVALID_GUEST_STATE | 33 | 客户机状态无效 |
| MSR_LOAD_FAIL | 34 | MSR加载失败 |
| MWAIT_INSTRUCTION | 36 | 执行MWAIT指令 |
| MONITOR_TRAP_FLAG | 37 | 监控陷阱标志触发 |
| MONITOR_INSTRUCTION | 39 | 执行MONITOR指令 |
| PAUSE_INSTRUCTION | 40 | 执行PAUSE指令 |
| MCE_DURING_VMENTRY | 41 | VM进入期间发生机器检查异常（MCE） |
| TPR_BELOW_THRESHOLD | 43 | 任务优先级寄存器（TPR）低于阈值 |
| APIC_ACCESS | 44 | 访问高级可编程中断控制器（APIC） |
| VIRTUALIZED_EOI | 45 | 执行虚拟化EOI |
| GDTR_IDTR | 46 | 访问GDTR或IDTR |
| LDTR_TR | 47 | 访问LDTR或TR |
| EPT_VIOLATION | 48 | 发生EPT违规 |
| EPT_MISCONFIG | 49 | 发生EPT配置错误 |
| INVEPT | 50 | 执行INVEPT指令 |
| RDTSCP | 51 | 执行RDTSCP指令 |
| PREEMPTION_TIMER | 52 | 抢占定时器超时 |
| INVVPID | 53 | 执行INVVPID指令 |
| WBINVD | 54 | 执行WBINVD指令 |
| XSETBV | 55 | 执行XSETBV指令 |
| APIC_WRITE | 56 | 发生APIC写操作 |
| RDRAND | 57 | 执行RDRAND指令 |
| INVPCID | 58 | 执行INVPCID指令 |
| VMFUNC | 59 | 执行VMFUNC指令 |
| ENCLS | 60 | 执行ENCLS指令 |
| RDSEED | 61 | 执行RDSEED指令 |
| PML_FULL | 62 | 页面修改日志（PML）已满 |
| XSAVES | 63 | 执行XSAVES指令 |
| XRSTORS | 64 | 执行XRSTORS指令 |
| PCONFIG | 65 | 执行PCONFIG指令 |
| SPP_EVENT | 66 | 发生SPP事件 |
| UMWAIT | 67 | 执行UMWAIT指令 |
| TPAUSE | 68 | 执行TPAUSE指令 |
| LOADIWKEY | 69 | 执行LOADIWKEY指令 |

### 中断类型（VmxInterruptionType）

| 枚举值 | 数值 | 中文解释 |
|--------|------|----------|
| External | 0 | 外部中断 |
| Reserved | 1 | 保留 |
| NMI | 2 | 不可屏蔽中断（NMI） |
| HardException | 3 | 硬件异常（如#PF） |
| SoftIntr | 4 | 软件中断（INT n） |
| PrivSoftException | 5 | 特权软件异常（INT1） |
| SoftException | 6 | 软件异常（INT3或INTO） |
| Other | 7 | 其他事件 |

### VM指令错误码（VmxInstructionError）

| 数值 | 中文解释 |
|------|----------|
| 0 | 成功 |
| 1 | 在VMX根模式下执行VMCALL |
| 2 | 使用无效物理地址执行VMCLEAR |
| 3 | 使用指向VMXON区域的指针执行VMCLEAR |
| 4 | 对非“清除”状态的VMCS执行VMLAUNCH |
| 5 | 对非“已启动”状态的VMCS执行VMRESUME |
| 6 | 在VMXOFF和VMXON之间执行VMRESUME |
| 7 | 使用无效控制字段进行VM进入 |
| 8 | 使用无效主机状态字段进行VM进入 |
| 9 | 使用无效物理地址执行VMPTRLD |
| 10 | 使用指向VMXON区域的指针执行VMPTRLD |
| 11 | 使用不正确的VMCS修订标识符执行VMPTRLD |
| 12 | 从/向不受支持的VMCS组件执行VMREAD/VMWRITE |
| 13 | 向只读VMCS组件执行VMWRITE |
| 15 | 在VMX根模式下执行VMXON |
| 16 | 使用无效执行VMCS指针进行VM进入 |
| 17 | 使用非“已启动”状态的执行VMCS进行VM进入 |
| 18 | 尝试停用SMI和SMM的双监控处理时，执行VM进入且执行VMCS指针不是VMXON指针 |
| 19 | 尝试激活SMI和SMM的双监控处理时，使用非“清除”状态的VMCS执行VMCALL |
| 20 | 尝试激活SMI和SMM的双监控处理时，VMCALL使用无效的VM退出控制字段 |
| 22 | 尝试激活SMI和SMM的双监控处理时，VMCALL使用不正确的MSEG修订标识符 |
| 23 | 在双监控处理SMI和SMM期间执行VMXOFF |
| 24 | 尝试激活SMI和SMM的双监控处理时，VMCALL使用无效的SMM监控特性 |
| 25 | 尝试从SMM返回时，执行VM进入且执行VMCS中存在无效的VM执行控制字段 |
| 26 | VM进入时存在被MOV SS阻塞的事件 |
| 28 | INVEPT/INVVPID指令的操作数无效 |

**Section sources**
- [definitions.rs](file://src/vmx/definitions.rs#L0-L274)

## 错误码对照表

本节说明不同错误类型的具体含义及应对措施。

### VmxInstructionError
该类型表示VMX指令执行过程中发生的错误。当VMX指令因违反规则而失败时，会通过`VM-instruction error number`字段返回一个错误码。

| 错误码 | 可能原因 | 应对措施 |
|--------|--------|---------|
| OK (0) | 指令成功执行 | 无需处理 |
| VMCALL executed in VMX root operation (1) | 在VMX根模式下调用了VMCALL | 确保仅在非根模式下执行VMCALL |
| VMCLEAR with invalid physical address (2) | 提供给VMCLEAR的物理地址无效 | 验证地址是否在有效范围内且对齐 |
| VMPTRLD with incorrect VMCS revision identifier (11) | VMCS的修订标识符不匹配当前处理器 | 确保VMCS由正确版本的处理器创建 |
| VM entry with invalid control field(s) (7) | VMCS中的控制字段包含非法值 | 根据SDM验证所有控制字段的合法性 |
| VMWRITE to read-only VMCS component (13) | 尝试写入只读的VMCS字段 | 查阅SDM确认目标字段的可写性 |
| VMXON executed in VMX root operation (15) | 在已处于VMX根模式时再次执行VMXON | 确保在调用VMXON前未处于VMX模式 |
| Invalid operand to INVEPT/INVVPID (28) | INVEPT或INVVPID的操作数格式错误 | 检查操作数类型和地址有效性 |

**Section sources**
- [definitions.rs](file://src/vmx/definitions.rs#L0-L274)

## VT-x特性支持程度

本节记录当前版本对Intel VT-x特性的支持情况。

### 已实现功能
- **基本VMX操作**：支持VMXON、VMXOFF、VMLAUNCH、VMRESUME等核心指令。
- **VMCS管理**：支持VMPTRLD、VMPTRST、VMCLEAR、VMREAD、VMWRITE等VMCS操作。
- **VM-exit处理**：完整实现了`VmxExitReason`枚举中定义的所有退出原因的识别与分发。
- **中断虚拟化**：支持外部中断、NMI、异常等中断类型的虚拟化处理。
- **I/O和MSR拦截**：能够拦截并处理客户机对I/O端口和MSR的访问。
- **EPT支持**：支持扩展页表（EPT），包括EPT违规和EPT配置错误的处理。
- **控制寄存器访问**：能够拦截对CR0、CR3、CR4等控制寄存器的读写操作。
- **调试寄存器访问**：支持对DR0-DR7的访问拦截。

### 未实现功能
- **嵌套虚拟化**：尚未实现基于VMCS阴影（VMCS shadowing）的嵌套虚拟化支持。
- **VMCS阴影优化**：未启用VMCS阴影以提升性能。
- **某些高级特性**：如VMCS多处理器唤醒（MP-wait）、虚拟中断压缩（virtual interrupt compression）等高级特性暂未实现。
- **部分新兴指令**：如TPAUSE、UMWAIT等较新引入的指令拦截支持可能不完整。

**Section sources**
- [definitions.rs](file://src/vmx/definitions.rs#L0-L274)

## 版本兼容性说明

本节说明项目的依赖关系和版本要求。

### Rust版本依赖
- 项目通过`rust-toolchain.toml`文件锁定使用的Rust工具链版本。
- 当前要求使用特定的Nightly版本以确保对底层硬件操作和内联汇编的支持。
- 建议严格遵循`rust-toolchain.toml`指定的版本，避免因编译器行为变化导致的未定义行为。

### Arceos框架版本
- 该项目是Arceos操作系统框架的一部分，其API和内部约定与特定版本的Arceos紧密耦合。
- 必须使用与本模块开发时对应的Arceos核心库版本进行编译和链接。
- 不同版本的Arceos可能在内存管理、中断处理、并发原语等方面有重大变更，直接替换可能导致运行时错误。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L1-L20)
- [rust-toolchain.toml](file://rust-toolchain.toml#L1-L5)

## 术语表

| 英文术语 | 中文翻译 | 解释 |
|---------|--------|------|
| VMX | 虚拟机扩展 | Intel处理器提供的硬件辅助虚拟化技术 |
| VMCS | 虚拟机控制结构 | 存储虚拟机状态和控制信息的数据结构 |
| VM Entry | VM进入 | 从VMM切换到客户机操作系统的过程 |
| VM Exit | VM退出 | 从客户机操作系统切换回VMM的过程 |
| VMM | 虚拟机监视器 | 负责管理和调度虚拟机的软件层，即Hypervisor |
| Hypervisor | 虚拟机监视器 | 同VMM，负责虚拟化资源的分配与管理 |
| Guest OS | 客户机操作系统 | 运行在虚拟机中的操作系统 |
| Host OS | 宿主机操作系统 | 运行在物理硬件上的操作系统（在裸金属Hypervisor中可能不存在） |
| EPT | 扩展页表 | 用于虚拟化内存管理单元（MMU）的硬件机制 |
| SMM | 系统管理模式 | x86架构中一种高特权级别的操作模式，通常用于固件实现 |
| SMI | 系统管理中断 | 触发进入SMM模式的中断 |
| MSR | 模型特定寄存器 | x86处理器中用于配置和查询特定功能的寄存器 |
| CR | 控制寄存器 | x86处理器中用于控制处理器操作模式和特性的寄存器（如CR0, CR3, CR4） |
| DR | 调试寄存器 | x86处理器中用于支持硬件调试功能的寄存器（如DR0-DR7） |
| APIC | 高级可编程中断控制器 | 处理处理器间中断（IPI）和本地中断的硬件组件 |
| TPR | 任务优先级寄存器 | APIC中用于设置当前任务中断优先级的寄存器 |

**Section sources**
- [definitions.rs](file://src/vmx/definitions.rs#L0-L274)